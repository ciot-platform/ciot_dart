name: Auto Release

on:
  push:
    branches:
      - main
      - develop
      - release
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (leave empty to use pubspec.yaml version)"
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.x"
          channel: "stable"

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          fi

          # Determinar sufixo baseado na branch
          BRANCH="${{ github.ref_name }}"

          if [ "$BRANCH" = "develop" ]; then
            # Branch develop: adicionar sufixo -alpha
            if [[ ! "$VERSION" =~ -alpha ]]; then
              VERSION="${VERSION}-alpha"
            fi
            IS_PRERELEASE="true"
          elif [ "$BRANCH" = "release" ]; then
            # Branch release: adicionar sufixo -beta
            if [[ ! "$VERSION" =~ -beta ]]; then
              VERSION="${VERSION}-beta"
            fi
            IS_PRERELEASE="true"
          elif [ "$BRANCH" = "main" ]; then
            # Branch main: release estÃ¡vel (remover qualquer sufixo)
            VERSION=$(echo "$VERSION" | sed 's/-alpha.*$//' | sed 's/-beta.*$//' | sed 's/-rc.*$//' | sed 's/-dev.*$//')
            IS_PRERELEASE="false"
          fi

          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "raw_version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Branch: $BRANCH"
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ·ï¸  Pre-release: $IS_PRERELEASE"

      - name: Check if tag exists
        id: tag_check
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âŒ Tag ${{ steps.version.outputs.version }} already exists"
            exit 1
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.version.outputs.version }} is available"
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test --coverage

      - name: Create package archive
        run: |
          mkdir -p release
          tar -czf release/ciot_dart-${{ steps.version.outputs.raw_version }}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='build' \
            --exclude='*.log' \
            --exclude='release' \
            .

      - name: Generate changelog
        run: |
          echo "# Release Notes for ${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # Adicionar badge de tipo de release
          BRANCH="${{ steps.version.outputs.branch }}"
          if [ "$BRANCH" = "develop" ]; then
            echo "ðŸ”¬ **Alpha Release** - Development build from \`develop\` branch" >> RELEASE_NOTES.md
          elif [ "$BRANCH" = "release" ]; then
            echo "ðŸ§ª **Beta Release** - Release candidate from \`release\` branch" >> RELEASE_NOTES.md
          elif [ "$BRANCH" = "main" ]; then
            echo "âœ… **Stable Release** - Production-ready release from \`main\` branch" >> RELEASE_NOTES.md
          fi
          echo "" >> RELEASE_NOTES.md

          # Obter Ãºltima tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "## ðŸŽ‰ Initial Release" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "This is the first release of ciot_dart!" >> RELEASE_NOTES.md
          else
            echo "## ðŸ“‹ Changes since $LAST_TAG" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Adicionar commits desde a Ãºltima tag
            git log $LAST_TAG..HEAD --oneline --no-merges | while read commit; do
              echo "- $commit" >> RELEASE_NOTES.md
            done
          fi

          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“¦ Package Information" >> RELEASE_NOTES.md
          echo "- **Package**: ciot_dart" >> RELEASE_NOTES.md
          echo "- **Version**: ${{ steps.version.outputs.raw_version }}" >> RELEASE_NOTES.md
          echo "- **Branch**: ${{ steps.version.outputs.branch }}" >> RELEASE_NOTES.md
          echo "- **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> RELEASE_NOTES.md
          echo "- **Commit**: ${{ github.sha }}" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“š Installation" >> RELEASE_NOTES.md
          echo '```yaml' >> RELEASE_NOTES.md
          echo "dependencies:" >> RELEASE_NOTES.md
          echo "  ciot_dart:" >> RELEASE_NOTES.md
          echo "    git:" >> RELEASE_NOTES.md
          echo "      url: https://github.com/${{ github.repository }}.git" >> RELEASE_NOTES.md
          echo "      ref: ${{ steps.version.outputs.version }}" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "ciot_dart ${{ steps.version.outputs.version }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
          files: |
            release/ciot_dart-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.version }} created successfully!"
          echo "ðŸ“¦ Files uploaded:"
          ls -la release/ciot_dart-*.tar.gz
          echo ""
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
